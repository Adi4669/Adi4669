<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login-window</title>
    <link rel="stylesheet" href="login.css" />
  </head>
  <body>
    <div class="header">
      <div class="home">
        <a href="bd.html" class="home-btn" onclick="pageTransition(event)">
          The Red Thread
        </a>
        <span class="tooltip">Home</span>
      </div>
    </div>
    <h1
      style="
        text-align: center;
        font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
        font-size: 40px;
      ">
      The Red Thread Log-in
    </h1>
    <div id="container" class="login-container">
      <div id="form1" class="login-grid">
        <h2>Blood Bank Login: Portal/Application</h2>
        <p style="font-size: 20px; margin-top: 0">
          Enter your username and password to login:
        </p>
        <div class="input-wrapper">
          <input
            class="input"
            id="username"
            name="username"
            placeholder=""
            required />
          <label for="username">Username</label>
        </div>

        <p
          id="error-msg"
          style="color: red; display: none; margin-top: 10px"></p>

        <div class="input-wrapper">
          <input
            class="input"
            id="password"
            type="password"
            name="password"
            placeholder=""
            required />
          <label for="password">Password</label>
        </div>

        <div class="but-layout">
          <a href="signed_in.html" class="signin" onclick="nextPage(event)"
            >Sign In!</a
          >
          <a class="signup" href="signup.html">New User?<br />Sign Up!</a>
        </div>
        <a class="fpw" href=""><br />Forgot Password?</a>
      </div>

      <div id="form2" style="display: none">
        <h2 id="welcome_msg" style="text-align: center">Welcome!</h2>
        <p>You have successfully logged in.</p>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:4000";

      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      async function nextPage(e) {
        e.preventDefault();

        const form = document.getElementById("form1");
        const email = form.querySelector('input[name="username"]').value.trim();
        const password = form
          .querySelector('input[name="password"]')
          .value.trim();
        const errorMsg = document.getElementById("error-msg");

        if (email === "" || password === "") {
          errorMsg.textContent = "Error: Please fill all the fields!";
          errorMsg.style.display = "block";
          return;
        }

        if (!isValidEmail(email)) {
          errorMsg.textContent = "Error: Please enter a valid email address.";
          errorMsg.style.display = "block";
          return;
        }

        errorMsg.style.display = "none";

        try {
          const res = await fetch(`${API_BASE}/api/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ email, password }),
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.message || "Login failed");
          }

          const data = await res.json();
          if (data.token) {
            localStorage.setItem("token", data.token);
          }

          // Determine destination based on role; fallback to /me if role missing
          let role = data.user?.role;
          if (!role && data.token) {
            try {
              const meRes = await fetch(`${API_BASE}/api/auth/me`, {
                headers: {
                  Authorization: `Bearer ${data.token}`,
                  Accept: "application/json",
                },
                credentials: "include",
              });
              if (meRes.ok) {
                const meData = await meRes.json();
                role = meData.user?.role;
              }
            } catch (_) {}
          }

          if (role === "admin") {
            window.location.href = "admin.html";
          } else {
            window.location.href = "signed_in.html";
          }
        } catch (err) {
          errorMsg.textContent = err.message || "Login failed";
          errorMsg.style.display = "block";
        }
      }
    </script>
  </body>
</html>
